var Plugins=function(){function b(){a.length&&(purge=0,a.each(function(){isInWindow(this)&&(this.pluginBox.updateInfo(),this.pluginBox.$box.removeClass("info-loading"),purge++)}),purge&&(a=$("#all-plugins .info-loading")))}function d(a,b){$("#pl-info-title").text(a.title),$("#pl-info-logo").css("background-image",b),$("#pl-info-author").text(a.author),$("#pl-info-version").text(a.version),$("#pl-info-desc").html(a.require)}function e(a,b,e){function p(){console.log("completing (de)installation for plugin "+f.plugin.author+" > "+f.plugin.title),$.post("plugin/toggle-install.php",{p:f.plugin.idx},null,"json").done(function(a){return a.error?alert("Errore\n"+a.error):(h=a.installed,console.log("plugin "+f.plugin.author+" > "+f.plugin.title+" has been "+(h?"":"un-")+"installed."),void(h?f.$box.removeClass("install"):f.$box.addClass("install")))}).fail(function(a){console.log(a),alert("Ooops!")}).always(function(){o.end()})}function q(){f.$info.html("<h4>"+f.plugin.title+" di <i>"+f.plugin.author+'</i></h4><p class="version" data-version="'+printAttr(f.plugin.version)+'"><code>v.'+printText(f.plugin.version)+"</code></p>")}function r(){return!!l&&(d(f.plugin,f.$box.find(".logo").css("background-image")),void l.modalbox("open"))}function s(){if(!m)return!1;var a=m.find("iframe")[0];a.src!==j&&(a.src=j),m.modalbox("open")}var f=this,g=!1,h=!1,i=!1,j=null,k=!1,l=null,m=null;f.$box=null,f.$info=null,f.$loader=null,f.plugin=null,f.init=function(a,b,c){if(!a||!b)return!1;if(f.$box)return!1;a[0].pluginBox=f,f.$box=a,f.$info=a.find(".info"),l=b?b:null,m=c?c:null,haslogo=a.find(".logo").css,h=!a.hasClass("install"),i=a.hasClass("active"),j=function(){var b=a.find(".plugin-custom");return b.length?b.click(function(a){a.preventDefault(),f.openCustom()})[0].href:null}();var d=a.find(".plugin-install").click(function(a){a.preventDefault(),f.install()}).data("plugin");return a.find(".plugin-activate").click(function(a){a.preventDefault(),f.activate()}),f.plugin={url:d},d=d.match(/\/([a-z0-9]+)\/([a-z0-9]+)\/$/i),f.plugin.author=d[1],f.plugin.title=d[2],f.plugin.idx=d[1]+"/"+d[2],a.find(".plugin-info input").change(f.openInfo),f.$loader=a.find(".loader p"),f};var o={start:function(a){a||(a="occupato..."),a=f.plugin.author+" "+f.plugin.title+" "+a,console.log(a),k=!0,f.$loader.html(a),f.$box.addClass("loading")},end:function(){k=!1,f.$box.removeClass("loading")}};return f.install=function(){return!(!f.plugin||k)&&(o.start("installazione in corso"),void $.post(f.plugin.url+"installer.php",{install:!h},null,"json").done(function(a){return a.error?(o.end(),alert("Errore\n"+a.error)):void p()}).fail(function(a){console.log(a),o.end(),alert("Ooops!")}))},f.activate=function(){return!(!h||!f.plugin||k)&&(o.start("attivazione in corso"),void $.post("plugin/toggle-active.php",{p:f.plugin.idx},null,"json").done(function(a){return a.error?alert("Errore\n"+a.error):(i=a.active,console.log("plugin "+f.plugin.author+" > "+f.plugin.title+" has been "+(i?"":"de-")+"activated."),void(i?f.$box.addClass("active"):f.$box.removeClass("active")))}).fail(function(a){console.log(a),alert("Ooops!")}).always(function(){o.end()}))},f.updateInfo=function(a,b){return!(!f.plugin||k)&&(o.start("ricerca info"),void $.get(f.plugin.url+"director.json",null,null,"json").done(function(b){console.log(b),f.plugin=$.extend(f.plugin,b),g=!0,q(),a&&a()}).fail(function(a){console.log(a),alert("Ooops!"),b&&b()}).always(function(){o.end()}))},f.openInfo=function(){return!(!f.plugin||k)&&(g?r():f.updateInfo(r),f)},f.openCustom=function(){return!(!j||k)&&(s(),f)},a&&f.init(a,b,e),f.id=c.push(f)-1,f.$box[0].id="-box-"+f.id,f}var a=[],c=[];return $.fn.pluginBox=function(){var a=$("#plugin-info"),b=$("#plugin-custom-page");return this.each(function(){new e($(this),a,b)})},$(function(){$("#all-plugins .plugin-box").pluginBox(),a=$("#all-plugins .info-loading"),$(this).on("scroll.lazy resize.lazy",b),b()}),c}();