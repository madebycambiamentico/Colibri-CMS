!function(){function e(e,a){var t="alb-"+e.id,i=1===r.jsimage&&void 0!==e.img,l='<figure class="album" id="album-'+e.id+'"><div class="icon i-jpg'+(i?' load" data-thumb="img/thumbs/'+printAttr(e.img):"")+'"><label for="'+t+'" class="image" id="L'+t+'"'+(i?"":"style=\"background:url('img/thumbs/"+printAttr(e.img)+"')\"")+'></label></div><div class="title"><label for="'+t+'">'+printText(e.t)+'</label></div><figcaption><input type="radio" name="album" id="'+t+'" data-img="'+printAttr(e.img)+'" data-t="'+printAttr(e.t)+'" value="'+e.id+'"><b class="sicon ed" data-id="'+e.id+'"><i class="pencil"></i></b><b class="sicon del" data-id="'+e.id+'"><i class="trash"></i></b></figcaption></figure>';return a&&(l=$(l).setFigureTitle(),l.find("#"+t).setAsAlbum(),l.find("b.ed").editAlbum(),l.find("b.del").deleteAlbum()),l}function a(e,a,t){$("#edit-album")[0].reset(),$("#ealb-id").val(e),$("#ealb-title").val(a),$("#ealb-image").val(t),ACTIVE_VIEW="#ealb-all-images",$("#edit-album-popup").modalbox(),n(e,0)}function t(e){return confirm("Vuoi veramente cancellare l'album\n"+$("#album-"+e).data("t")+"?\nNon sarà più disponibile per nessun articolo precedentemente collegato.")?(BUSY.start(),$.ajax({type:"GET",dataType:"json",data:{id:e},url:"database/album-delete.php"}).done(function(e){return e.error?alert("ERRORE:\n"+e.error):void $("#album-"+e.id).remove()}).fail(function(e){console.log(e),alert("Oooops!")}).always(function(){BUSY.end()}),!0):!1}function i(a){$("#all-albums").prepend(e(a,!0))}function l(e){if("t"in e&&($("#album-"+e.id+" .title>label").text(e.t),$("#alb-"+e.id).data("t",e.t),$("#album-"+e.id).setFigureTitle()),"img"in e)switch(e.img){case!0:break;case!1:$("#album-"+e.id+" label.image").css("background-image","none"),$("#alb-"+e.id).data("img","");break;default:$("#album-"+e.id+" label.image").css("background-image",'url("img/thumbs/'+printAttr(e.img)+'")'),$("#alb-"+e.id).data("img",e.img)}}function n(e,a){switch(a){case 0:a=0;break;case 1:a=1;break;case 2:a=2;break;default:a=0}return 1>=a&&$("#ealb-all-images").empty(),$.get("database/album-get-images.php",{id:e,request:a},null,"json").done(function(e){if(e.error)return alert("ERRORE:\n"+e.error);var a="";$.each(e.images,function(e,t){a+=getHtmlImage(t)}),$("#ealb-all-images").append(a),$("#ealb-all-images input").setAsImage(),updateView()}).fail(function(e){console.log(e),alert("Oooops!")}).always(function(){}),!0}function s(e){var a="database/album-add-or-edit.php",t={id:$("#ealb-id").val(),title:$("#ealb-title").val(),image:$("#ealb-image").val()};if(!t.title)return alert("Non puoi inserire un album senza titolo!"),!1;switch(e){case"title":case 1:t.id&&(a="database/album-edit-title.php");break;case"image":case 2:t.id&&(a="database/album-edit-image.php")}return BUSY.start(),$.ajax({type:"GET",dataType:"json",data:$("#edit-album").serialize(),url:a}).done(function(e){return e.error?alert("ERRORE:\n"+e.error):void("insert"==e.success?(i(e),alert("Album inserito con successo.")):"update"==e.success&&(l(e),alert("Modifica album effettuata.")))}).fail(function(e){console.log(e),alert("Oooops!")}).always(function(){BUSY.end()}),!0}var r={jsimage:1};$.fn.setFigureTitle=function(){return this.each(function(){$(this).attr("data-t",$(this).find(".title label").text().toLowerCase())})},$.fn.setAsAlbum=function(){return this.change(function(){var e=this.value;$("#all-albums figure").removeClass("selected"),$("#album-"+e).addClass("selected")})},$.fn.editAlbum=function(){return this.click(function(){var e=$(this).data("id"),t=$("#alb-"+e).data("t"),i=$("#alb-"+e).data("img");a(e,t,i)})},$.fn.deleteAlbum=function(){return this.click(function(){var e=$(this).data("id");t(e)})},window.getHtmlImage=function(e,a){var t="img-"+e.id,i=e.src.split("/").pop().replace(/\.[a-z0-9]+$/i,""),l='<figure id="image-'+e.id+'"'+(e.select?' class="selected"':"")+'><div class="icon i-jpg'+(1==r.jsimage?' load" data-thumb="img/thumbs/'+printAttr(e.src):"")+'"><label for="'+t+'" class="image" id="L'+t+'"'+(1==r.jsimage?"":"style=\"background:url('img/thumbs/"+printAttr(e.src)+"')\"")+'></label></div><div class="title"><label id="imagesrc-'+e.id+'" for="'+t+'">'+printText(i)+'</label></div><figcaption><input type="checkbox" name="IMAGES[]" id="'+t+'" value="'+e.id+'"'+(e.select?" checked":"")+'><b class="sicon" onclick="preview('+e.id+')"><i class="search"></i></b></figcaption></figure>';return a&&(l=$(l),l.find("#"+t).setAsImage()),l},$.fn.setAsImage=function(){return this.change(function(){var e=this.value;this.checked?$("#image-"+e).addClass("selected"):$("#image-"+e).removeClass("selected")})},$(function(){$("#at-0").change(function(){a("","","")}),$("#at-1").change(function(){var e=$("#all-albums input:checked");if(!e.length)return!1;var t=e[0].id,i=e.data("t"),l=e.data("img");a(t,i,l)}),$("#at-2").change(function(){$("#my-article")[0].reset(),$("#my-article .selected").removeClass("selected")}),$("#at-3").change(function(){var e=$("#all-albums input:checked");if(!e.length)return!1;var a=e[0].value;t(a)}),$("#ealb-fm-1").click(function(){FM_LISTENER=0,openFM("image")}),$("#ealb-fm-1-del").click(function(){$("#ealb-image").val("")}),$("#edit-album .savealbum").click(function(){s($(this).data("action"))}),$("#all-albums>figure").setFigureTitle(),$("#all-albums input").setAsAlbum(),$("#all-albums b.ed").editAlbum(),$("#all-albums b.del").deleteAlbum(),$("#edit-album-popup .popup").on("scroll.lazy resize.lazy",checkLoadImage),$("#edit-album-popup")[0].modalbox.on.close=function(){updateView("#all-albums")}})}();