/**
 * @author: nereo costacurta
 *
 * @project: colibrì CMS | madebycambiamentico
 * @description: personal profile editor (image, password, email).
 *
 * @require: [jquery.js >= 1.11.3], common.js, simple-modal-box.js
 *
 * @license: GPLv3
 * @copyright: (C)2016 nereo costacurta
 * @minified 2016/01/27
**/
!function(){function r(r){r.image?$("#pf-image").css("background-image",'url("img/users/'+printAttr(r.image)+"256.png?"+(new Date).getTime()+'")'):$("#pf-image").css("background-image",'url("img/users/default/face-256.png")'),$("#upload-files").modalbox("off")}function e(r){var e=$("#my-password").val().trim(),o=$("#my-password-n").val().trim();if(o.length<8)return alert("La password è troppo corta!"),!1;var t=$("#my-password-nr").val().trim();if(o!=t)return alert("La password è troppo corta!"),!1;var a=new jsSHA("SHA-512","TEXT");a.update(e);var n=a.getHash("HEX");$("#my-hashed-pass").val(n),a=new jsSHA("SHA-512","TEXT"),a.update(o);var i=a.getHash("HEX");return $("#my-hashed-pass-new").val(a.getHash("HEX")),$.isFunction(r)&&r(n,i),!0}function o(){var r=this;r.scorePassword=function(r){var e=0;if(!r)return e;for(var o=new Object,t=0;t<r.length;t++)o[r[t]]=(o[r[t]]||0)+1,e+=5/o[r[t]];var a={digits:/\d/.test(r),lower:/[a-z]/.test(r),upper:/[A-Z]/.test(r),nonWords:/\W/.test(r)};variationCount=0;for(var n in a)variationCount+=1==a[n]?1:0;return e+=10*(variationCount-1),parseInt(e)},r.textPassStrength=function(r){return r>80?"forte":r>60?"buona":r>=30?"debole":0==r?"":"debolissima"};var e=[{pct:0,color:{r:255,g:0,b:0}},{pct:.5,color:{r:255,g:255,b:0}},{pct:1,color:{r:0,g:255,b:0}}];return r.getColorForPercentage=function(r){if(!r)return"inherit";for(var o=1;o<e.length-1&&!(r<e[o].pct);o++);var t=e[o-1],a=e[o],n=a.pct-t.pct,i=(r-t.pct)/n,s=1-i,l=i,u={r:Math.floor(t.color.r*s+a.color.r*l),g:Math.floor(t.color.g*s+a.color.g*l),b:Math.floor(t.color.b*s+a.color.b*l)};return"rgb("+[u.r,u.g,u.b].join(",")+")"},r.input=null,r.meter=null,r.initMeter=function(e,o){return r.input=e,r.meter=o,e.keyup(function(){var e=$(this).val(),t=Math.min(r.scorePassword(e),100),a=r.getColorForPercentage(t/100);o.css({backgroundColor:a,width:t+"%"}).text(r.textPassStrength(t))}),r},r}function t(r,e){BUSY.start(),$.post("database/user-edit.php",{action:"pass",p0:r,p1:e,hint:$("#my-password-hint").val()},null,"json").success(function(r){return r.error?alert("ERRORE:\n"+r.error):(alert("Password modificata correttamente"),$("#all-pass-inputs input").val(""),void d.input.keyup())}).error(function(r){console.log(r),alert("Oooops!")}).always(function(){BUSY.end()})}function a(){return confirm("Sei sicuro di voler rimuovere la tua immagine?\nVerrà sostituita dal profilo standard.")?(BUSY.start(),void $.get("database/user-image.php",{remove:!0},null,"json").success(function(e){return e.error?alert("ERRORE:\n"+e.error):void r(e)}).error(function(r){console.log(r),alert("Oooops!")}).always(function(){BUSY.end()})):!1}function n(r){var e=$("#my-email").val(),o=$("#my-email-new").val();if(""!==o){if(!/[a-z0-9!#$%&'*+\/=?^_`{|}~-]+(?:\.[a-z0-9!#$%&'*+\/=?^_`{|}~-]+)*@(?:[a-z0-9](?:[a-z0-9-]*[a-z0-9])?\.)+[a-z0-9](?:[a-z0-9-]*[a-z0-9])?/i.test(o)&&!confirm("ATTENZIONE!!!\nNon sembra una mail quella che hai appena inserito... procedere comunque?"))return!1}else if(!confirm("ATTENZIONE!!!\nNon hai inserito la nuova email: in questo modo verrà rimossa definitivamente\ne non potrai più essere contattato o recuperare i tuoi dati. Procedere comunque?"))return!1;return $.isFunction(r)&&r(e,o),!0}function i(r,e){BUSY.start(),$.post("database/user-edit.php",{action:"email",e0:r,e1:e},null,"json").success(function(r){return r.error?alert("ERRORE:\n"+r.error):(alert("e-mail modificata correttamente"),$("#my-email-hint").text(r.email),$("#all-email-inputs input").val(""),void 0)}).error(function(r){console.log(r),alert("Oooops!")}).always(function(){BUSY.end()})}var s=!1,l=$('<div class="fallback-res">'),u=$('<div class="fallback-progress">'),c=$('<div class="fallback-bar">'),p=$('<div class="fallback-perc">');$("#my-dropzone").append(l).append(u.append(c).append(p)).ajaxForm({dataType:"json",beforeSend:function(){return s?!1:(s=!0,u.addClass("uploading"),l.hide(),c.css("width","0%"),void p.html("0%"))},uploadProgress:function(r,e,o,t){var a=t+"%";c.width(a),p.text(a)},success:function(e){return e.error!==!1?alert("ERRORE\n"+e.error):(r(e),void(s=!1))},error:function(r){l.html(r.responseText).show(),alert("Ooops!"),s=!1}}),$("#ui-file").change(function(){var r=$(this).val();r?$("#onupload").text(r):$("#onupload").text("nessun file selezionato")});var d;$(function(){$("#savePass").click(function(){e(t)}),$("#saveEmail").click(function(){n(i)}),$("#pf-image b").click(function(){$("#upload-files").modalbox()}),d=(new o).initMeter($("#my-password-n"),$("#passmeter p")),$("#saveImage").click(function(){$("#my-dropzone").submit()}),$("#deleteImage").click(a),$("#upload-files").modalbox({maxH:300},null,!0)})}();