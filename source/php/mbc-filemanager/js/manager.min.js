/**
 * @author: nereo costacurta
 *
 * @project: colibrì CMS | madebycambiamentico
 * @description: file manager main script. manage edits, upload, delete.
 *
 * @require: [jquery.js >= 1.11.3], ./manager.php
 *
 * @license: GPLv3
 * @copyright: (C)2016 nereo costacurta
 *
 * @minified 2016-02-10
 */
function printAttr(e){return e?e.replace(/"/g,"&quot;").replace(/'/g,"&#039;"):""}function printText(e){return e?e.replace(/</g,"&lt;").replace(/>/g,"&gt;"):""}function isInWindow(e){var i=e.getBoundingClientRect();return i.top<=25&&i.bottom>=window.innerHeight-25||i.top>=25&&i.top<=window.innerHeight-25||i.bottom>25&&i.bottom<window.innerHeight-25}function checkLoadImage(){ACTIVE_IMAGES.length&&(purge=0,ACTIVE_IMAGES.each(function(){if(isInWindow(this)){var e=$(this).addClass("wait").removeClass("load"),i=e.data("thumb");$("<img>").load(function(){e.children("label").css("background-image",'url("'+i+'")'),setTimeout(function(){e.addClass("loaded").removeClass("wait")},30)}).error(function(e){console.log(e)})[0].src=i,purge++}}),purge&&(ACTIVE_IMAGES=$("#dir-"+ACTIVE_FOLDER+" .load")))}function initLazyLoad(){$(window).on("scroll.lazy resize.lazy",checkLoadImage)}function getFolderHtml(e,i,l,t){var r="dir_"+l+"-"+i,a='<figure class="type-F"><div class="icon i-folder"><label for="'+r+'" class="image"></label></div><div class="title"><label for="'+r+'">'+printText(e)+'</label></div><figcaption><input name="md" id="'+r+'" type="radio" value=""><b class="sicon ed"><i class="pencil"></i></b><b class="sicon"><i class="trash"></i></b></figcaption></figure>';return t?(a=$(a),a.find("#"+r).setAsFolder(),a.find("b.ed").fileEdit(),a):a}function getFolderUpHtml(e,i,l){var t="up_"+e+"-"+i,r='<figure class="type-U"><div class="icon i-folderup"><label for="'+t+'" class="image"></label></div><div class="title"><label for="'+t+'">'+printText(OPENED_FOLDERS[i].dir)+'</label></div><input name="md" id="'+t+'" type="radio" value="'+i+'"></figure>';return l?(r=$(r),r.find("#"+t).setAsFolder(),r):r}function newFolder(){LAST_EDIT_FILE=[!1,!1],$("#ef-type").val("newdir"),$("#ef-dir").val(OPENED_FOLDERS[ACTIVE_FOLDER].dir),$("#ef-title").val(""),$("#edit-files").removeClass("file").addClass("folder").modalbox({maxH:260}),$("#saveAllEdits").off().one("click",function(){editFile(ACTIVE_FOLDER)})}function getFileHtml(e,i,l,t){var r="file_"+l+"-"+e.g+"-"+i,a=e.f.substring(0,e.f.length-e.e.length-1),n='<figure class="file type-'+e.g+'">';switch(n+=0===e.g?'<div class="icon i-'+e.e+(1===MANAGER_OPTIONS.jsimage?' load" data-thumb="'+printAttr(OPENED_FOLDERS[l].turl+e.f):"")+'"><label for="'+r+'" class="image" id="L'+r+'"'+(0===MANAGER_OPTIONS.jsimage?"style=\"background:url('"+printAttr(OPENED_FOLDERS[l].turl+e.f)+"')\"":"")+"></label></div>":'<div class="icon i-'+e.e+'"><label for="'+r+'" class="image"></label></div>',n+='<div class="title"><label for="'+r+'">'+printText(a)+'</label></div><figcaption><input id="'+r+'" data-file="'+printAttr(e.f)+'" type="checkbox"><a class="sicon" href="'+printAttr(OPENED_FOLDERS[l].url+e.f)+'" target="_blank"><i class="download"></i></a>',e.g){case 0:n+='<b class="sicon pw"><i class="search"></i></b>';break;case 2:n+='<b class="sicon pw"><i class="video-camera"></i></b>';break;case 3:n+='<b class="sicon pw"><i class="audio-2"></i></b>'}return n+='<b class="sicon ed"><i class="pencil"></i></b><b class="sicon del"><i class="trash"></i></b></figcaption></figure>',t?(n=$(n).setFigureTitle(),n.find("#"+r).setAsFile(),n.find("b.pw").filePreview(),n.find("b.del").fileDelete(),n.find("b.ed").fileEdit(),n):n}function clearSel(){$("figure.selected input").click()}function deleteAllCheckedFiles(){return confirm("Si stanno per cancellare tutti i files selezionati (anche nelle altre cartelle). Vuoi veramente procedere?")?($("#manager_files .file input:checked").deleteAllCheckedFiles(),!0):confirm("Vuoi cancellare solo i file in questa cartella?")?($("#dir-"+ACTIVE_FOLDER+" .file input:checked").deleteAllCheckedFiles(),!0):!1}function deleteFiles(e){BUSY.start(),$.ajax({type:"POST",dataType:"json",data:{files:e},url:"delete-files.php"}).success(function(e){if(console.log(e),e.error)return alert("ERRORE:\n"+e.error);if($.each(e.done,function(e,i){$("#"+i.data.id).parents("figure.file").remove(),OPENED_FOLDERS[i.data.pf].files[i.data.g][i.data.i]=null}),MANAGER_OPTIONS.onChange("deleteFiles",e.done),e.fail.length){var i="Attenzione!!! I seguenti file non sono stati rimossi o sono stati rimossi solo parzialmente:";$.each(e.fail,function(e,l){i+="\n- "+l.f+" ("+l.e+")"}),alert(i)}}).error(function(e){console.log(e),alert("Oooops!")}).always(function(){BUSY.end()})}function editFile(e,i,l){return void 0===e?!1:(BUSY.start(),void $.get("update-file.php",$("#my-editor").serialize(),null,"json").done(function(t){if(console.log(t),t.error)return alert(t.error);switch(t.action){case"newdir":OPENED_FOLDERS[e].addFolder(t.f);break;case"dir":OPENED_FOLDERS[e].folders[i]=t.f,$('figure.type-F .title>label[for="dir_'+e+"-"+i+'"]').text(t.f),$("#up_"+$("#dir_"+e+"-"+i).val()+"-"+e).text(t.f);break;case"file":OPENED_FOLDERS[e].files[i][l].f=t.f,$('figure.file .title>label[for="file_'+e+"-"+i+"-"+l+'"]').text(t.f.replace(/\.[a-z0-9]+$/i,"")),void 0!==t.desc&&(OPENED_FOLDERS[e].files[i][l].desc=t.desc);break;default:return console.log(t)}$("#edit-files").modalbox()}).fail(function(e){console.log(e)}).always(function(){BUSY.end()}))}function FolderClass(){function e(e){$.each(e,function(){t.files[this.g].push(this)})}function i(){var e="";return $.each(t.folders,function(i){e+=getFolderHtml(this,i,t.ID,!1)}),e?(t.dom.append(e),!0):!1}function l(){var e="";return $.each(t.files,function(){$.each(this,function(i){e+=getFileHtml(this,i,t.ID,!1)})}),e?(t.dom.append(e),!0):!1}var t=this;return t.url="",t.folders=[],t.files=[[],[],[],[],[]],t.active=!1,t.ID=OPENED_FOLDERS.length,t.parentID=t.ID,OPENED_FOLDERS.push(t),t.dom=$('<div class="albums" id="dir-'+t.ID+'">'),t.addFolder=function(e){var i=t.folders.push(e)-1,l=t.dom.find("figure.type-F").eq(0),r=getFolderHtml(e,i,t.ID,!0);l.length?l.before(r):(l=t.dom.find("figure.type-U").last(),l.length?l.after(r):t.dom.prepend(r))},t.addFiles=function(e){console.log("adding files..."),console.log(e),$.each(e,function(e,i){t.addFile(i)}),MANAGER_OPTIONS.onChange("addFiles",e)},t.addFile=function(e){if("insert"===e.db){var i=t.files[e.g].push(e)-1,l=t.dom.find("figure.file").eq(0);return l.length?l.before(getFileHtml(e,i,t.ID,!0)):t.dom.append(getFileHtml(e,i,t.ID,!0)),0===e.g&&(ACTIVE_IMAGES=$("#dir-"+t.ID+" .load"),$(window).trigger("resize.lazy")),!0}return 0===e.g&&$.each(t.files[0],function(i,l){return l.f===e.f?($("#Lfile_"+t.ID+"-"+e.g+"-"+i).css("background-image",t.turl+e.f+"?"+(new Date).getTime()),!1):void 0}),!0},t.enable=function(e){e||$.each(OPENED_FOLDERS,function(){this.disable()}),t.dom.addClass("active"),t.active=!0,ACTIVE_FOLDER=t.ID,ACTIVE_IMAGES=$("#dir-"+t.ID+" .load"),checkLoadImage()},t.disable=function(){return t.active?(t.active=!1,t.dom.removeClass("active"),!0):!1},t.up=function(){return t.parentID?(t.disable(),OPENED_FOLDERS[t.parentID].enable(!0),t.parentID):t.ID},t.init=function(r,a){return t.dir=r.scanned_dir,t.url=r.uploads_dir+t.dir,t.turl=r.thumbs_dir+t.dir,t.folders=r.folders,e(r.files),void 0!==a&&(t.parentID=Number(a),t.dom.append(getFolderUpHtml(t.ID,t.parentID,!0))),i(),l(),t.dom.appendTo("#manager_files"),$("#dir-"+t.ID+">figure").setFigureTitle(),$("#dir-"+t.ID+">.type-F input").setAsFolder(),$("#dir-"+t.ID+">.file input").setAsFile(),$("#dir-"+t.ID+" b.pw").filePreview(),$("#dir-"+t.ID+" b.del").fileDelete(),$("#dir-"+t.ID+" b.ed").fileEdit(),t.enable(),t},t}function loadFolder(e,i,l){BUSY.start(),$.ajax({type:"GET",dataType:"json",data:{folder:e,filter:MANAGER_OPTIONS.filter},url:"get-file-list.php"}).success(function(e){if(console.log(e),e.error)return alert("ERRORE:\n"+e.error);var t=(new FolderClass).init(e,i).ID;l&&l(t)}).error(function(e){console.log(e),alert("Oooops!")}).always(function(){BUSY.end()})}var BUSY={busy:!0,dom:$("#loader"),start:function(){this.busy=!0,this.dom.removeClass("done")},end:function(){this.busy=!1,this.dom.addClass("done")}},OPENED_FOLDERS=[],ACTIVE_FOLDER=0,LAST_EDIT_FILE=[!1,!1],ACTIVE_IMAGES=[];1===MANAGER_OPTIONS.jsimage&&initLazyLoad(),$.fn.setAsFolder=function(){return this.change(function(){if(""===this.value){var e=this.id.match(/dir_(\d+)-(\d+)/);if(e){var i=this,l=Number(e[1]),t=Number(e[2]),r=OPENED_FOLDERS[l].dir+OPENED_FOLDERS[l].folders[t];loadFolder(r,l,function(e){i.value=e})}else console.log(e)}else{var a=Number(this.value);OPENED_FOLDERS[a].enable()}})},$.fn.setAsFile=function(){return this.change(function(){$(this).parents("figure.file").toggleClass("selected");var e=this.id.match(/file_(\d+)-(\d+)-(\d+)/);if(e){var i=Number(e[1]),l=Number(e[2]),t=Number(e[3]);MANAGER_OPTIONS.onChange(this.checked?"selectFile":"unselectFile",OPENED_FOLDERS[i].files[l][t],OPENED_FOLDERS[i].dir)}})},$.fn.setFigureTitle=function(){return this.each(function(){$(this).attr("data-title",$(this).find(".title label").text().toLowerCase())})},$.fn.filePreview=function(){return this.click(function(){var e=$(this).parent().find("input");if(!e.length)return!1;var i=e[0].id.match(/file_(\d+)-(\d+)-(\d+)/);if(i){var l=Number(i[1]),t=Number(i[2]),r=Number(i[3]),a=OPENED_FOLDERS[l].url+OPENED_FOLDERS[l].files[t][r].f;switch(t){case 0:break;case 2:$("#video-preview .video-wrapper").empty(),$("#video-preview").modalbox(),$('<video id="video-player" style="width:95%;height:95%" src="'+printAttr(a)+'" preload="false"></audio>').appendTo("#video-preview .video-wrapper").mediaelementplayer({success:function(e,i){e.play()},error:function(){$("#video-preview .video-wrapper").empty(),$("#video-preview").modalbox(),alert("Ooops! Il formato del video non è supportato!")}});break;case 3:$("#audio-preview .audio-wrapper").empty(),$("#audio-preview").modalbox(),$('<audio id="audio-player" src="'+printAttr(a)+'" preload="false"></audio>').appendTo("#audio-preview .audio-wrapper").mediaelementplayer({audioWidth:$(window).width()<480?300:420,success:function(e,i){e.play()},error:function(){$("#audio-preview .audio-wrapper").empty(),$("#audio-preview").modalbox(),alert("Ooops! Il formato dell'audio non è supportato!")}})}}else console.log(e[0].id)})},$.fn.fileEdit=function(){return this.click(function(){var e=$(this).parent().find("input");if(!e.length)return!1;var i=e[0].id.match(/file_(\d+)-(\d+)-(\d+)/);if(i){var l=Number(i[1]),t=Number(i[2]),r=Number(i[3]);if(LAST_EDIT_FILE[0]!==e[0].id){LAST_EDIT_FILE[0]=e[0].id,LAST_EDIT_FILE[1]=OPENED_FOLDERS[l].files[t][r];LAST_EDIT_FILE[1].f;if($("#ef-type").val("file"),$("#ef-dir").val(OPENED_FOLDERS[l].dir),$("#ef-orig-title").val(LAST_EDIT_FILE[1].f),$("#ef-title").val(LAST_EDIT_FILE[1].f.replace(/\.[a-z0-9]+$/i,"")),$("#ef-ext").html("."+LAST_EDIT_FILE[1].f.split(".").pop()),0===t){var a=$("#ef-desc").show();void 0===LAST_EDIT_FILE[1].desc?(a.val("").prop("disabled",!0),BUSY.start(),$.get("get-file-desc.php",{dir:OPENED_FOLDERS[l].dir,f:LAST_EDIT_FILE[1].f},null,"json").done(function(e){return console.log(e),e.error?alert(e.error):(a.val(e.desc),void(LAST_EDIT_FILE[1].desc=e.desc))}).fail(function(e){console.log(e)}).always(function(){BUSY.end(),a.prop("disabled",!1)})):a.val(LAST_EDIT_FILE[1].desc)}else $("#ef-desc").val("").hide()}$("#edit-files").removeClass("folder").addClass("file").modalbox({maxH:0===t?390:260}),$("#saveAllEdits").off().one("click",function(){editFile(l,t,r)})}else if(i=e[0].id.match(/dir_(\d+)-(\d+)/)){var l=Number(i[1]),r=Number(i[2]);LAST_EDIT_FILE=[!1,!1],$("#ef-type").val("dir"),$("#ef-dir").val(OPENED_FOLDERS[l].dir),$("#ef-orig-title").val(LAST_EDIT_FILE[1].f),$("#ef-title").val(OPENED_FOLDERS[l].folders[r]),$("#edit-files").removeClass("file").addClass("folder").modalbox({maxH:260}),$("#saveAllEdits").off().one("click",function(){editFile(l,r)})}else console.log(e[0].id)})},$.fn.fileDelete=function(){return this.click(function(){if(!confirm("Vuoi veramente cancellare questo file?"))return!1;var e=$(this).parent().find("input");if(!e.length)return!1;var i=e[0].id.match(/file_(\d+)-(\d+)-(\d+)/);if(i){var l=Number(i[1]),t=Number(i[2]),r=Number(i[3]);deleteFiles([{data:{id:e[0].id,pf:l,g:t,i:r},f:OPENED_FOLDERS[l].files[t][r].f,dir:OPENED_FOLDERS[l].dir}])}else console.log(e[0].id)})},$.fn.deleteAllCheckedFiles=function(){var e,i=new Array(this.length);return this.each(function(l){if(e=this.id.match(/file_(\d+)-(\d+)-(\d+)/)){var t=Number(e[1]),r=Number(e[2]),a=Number(e[3]);i[l]={data:{id:this.id,pf:t,g:r,i:a},f:OPENED_FOLDERS[t].files[r][a].f,dir:OPENED_FOLDERS[t].dir}}}),deleteFiles(i),this};var searchAndFilterTool={search:function(e){return e?(1===e.length&&$("#manager_files").addClass("searching"),$("#manager_files figure").removeClass("found"),checkLoadImage(),$('#manager_files figure[data-title*="'+e.replace(/"/g,'"')+'"]').addClass("found").length):($("#manager_files").removeClass("searching"),$("#manager_files figure").removeClass("found"),checkLoadImage(),!0)},filter:function(e){$("#manager_files").toggleClass("t-"+e),checkLoadImage()}};$.fn.searchTool=function(){return this.keyup(function(){searchAndFilterTool.search(this.value.toLowerCase())?$("#search-icon").removeClass("problem"):$("#search-icon").addClass("problem")})},$.fn.filterTool=function(){return this.change(function(){searchAndFilterTool.filter(this.value),$(this).next().find("i").toggleClass("checkboard")})},$(function(){if(function(){var e=$("<p>").css({webkitTransform:"translateZ(1px)",transform:"translateZ(1px)"}),i=e.css("-webkit-transform")||e.css("transform");return void 0!==i&&i.length>0&&"none"!==i}()||$("body").addClass("no3d"),$("#audio-preview").modalbox({maxH:260},{close:function(){var e=$("#audio-preview audio")[0];e&&e.player.pause()}},!0),$("#video-preview").modalbox(null,{close:function(){var e=$("#video-preview video")[0];e&&e.player.pause()}},!0),$("#upload-files").modalbox(null,{close:function(){setTimeout(function(){myDropzone.files.length&&myDropzone.removeAllFiles()},300)}},!0),$("#mt-new-folder").click(newFolder),$("#my-editor").submit(function(e){e.preventDefault()}),$("#mt-open-upload").click(function(){$("#uf-dir").val(OPENED_FOLDERS[ACTIVE_FOLDER].dir),$("#upload-files").modalbox()}),$("#search").searchTool(),$("#mt-open-filters").click(function(){$("#filters").toggleClass("active")}),$("#filters input").filterTool(),"all"!==MANAGER_OPTIONS.filter){var e=MANAGER_OPTIONS.getIntFilter();$("#filters input").each(function(i){i!==e&&$(this).prop("checked",!1).next().find("i").toggleClass("checkboard")})}$("#mt-delete-all").click(deleteAllCheckedFiles)});