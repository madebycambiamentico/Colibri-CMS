/**
 * @author: nereo costacurta
 *
 * @project: colibrì CMS | madebycambiamentico
 * @description: fallback for dropzone, ajax upload handler.
 *
 * @require: [jquery.js >= 1.11.3], ./manager.js
 *
 * @license: GPLv3
 * @copyright: (C)2016 nereo costacurta
 *
 * @minified 2016-02-10
 */
function onUploadedFiles(e){return e.error!==!1?(alert("ERRORE: "+e.error),!1):void OPENED_FOLDERS[ACTIVE_FOLDER].addFiles(e.done)}function formFallback(){myDropzone={files:[],removeAllFiles:$.noop},$("head").append("<link href='js/dropzone-4.2.0/dist/fallback.css' type='text/css' rel='stylesheet'>"),$.getScript("js/dropzone-4.2.0/dist/min/jquery.form.js").done(function(){var e=$('<div class="fallback-res">'),o=$('<div class="fallback-progress">'),a=$('<div class="fallback-bar">'),n=$('<div class="fallback-perc">');$("#my-dropzone").append(e).append(o.append(a).append(n)).ajaxForm({dataType:"json",beforeSend:function(){o.addClass("uploading"),e.toggle(),a.css("width","0%"),n.html("0%")},uploadProgress:function(e,o,l,i){var t=i+"%";a.width(t),n.text(t)},success:function(o){onUploadedFiles(o),e.html("<p>Upload completato</p>")},error:function(o){e.html(o.responseText).toggle(),alert("Ooops!")}})}).fail(function(e){console.log(e)})}var regexpTypeAllowed=function(){var e="\\.(",o=new Array(MANAGER_OPTIONS.allowedExt.length);return $.each(MANAGER_OPTIONS.allowedExt,function(e,a){o[e]=a.join("|")}),e+=o.join("|")+")$",new RegExp(e,"i")}(),myDropzone;Dropzone.options.myDropzone={paramName:"files[]",maxFilesize:100,fallback:formFallback,accept:function(e,o){e.name.match(regexpTypeAllowed)?o():o("Non è possibile caricare questo tipo di file.")},dictDefaultMessage:'<p><i class="cloud"></i>Clicca o trascina qui i file da caricare!</p>',init:function(){myDropzone=this,this.on("success",function(e,o){onUploadedFiles(o)}).on("complete",function(e,o){}).on("addedfile",function(e){e.type.match(/image.*/)||(match=e.name.match(regexpTypeAllowed),match?myDropzone.emit("thumbnail",e,"img/void.png","icon i-"+match[1]):(console.log(e.name+" is not in allowed types"),myDropzone.removeFile(e)))})}};